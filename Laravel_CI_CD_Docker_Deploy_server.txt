# ğŸ‘·â€â™‚ï¸ Nombre del workflow
name: Laravel Docker CI

# ğŸ” Ejecuta el workflow en push y PR hacia main
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  laravel-tests:
    runs-on: ubuntu-latest  # Usa Ubuntu como sistema base

    steps:
      # ğŸ§¾ 1. Clonar el repositorio
      - name: Checkout cÃ³digo
        uses: actions/checkout@v3

      # ğŸ³ 2. Levantar los contenedores definidos en docker-compose.yml
      - name: Levantar contenedores Docker
        run: docker-compose up -d --build

      # ğŸ•’ 3. Esperar que los servicios estÃ©n listos (evita errores en migraciones)
      - name: Esperar contenedor app
        run: sleep 10

      # ğŸ› ï¸ 4. Ejecutar migraciones (usar SQLite configurado en .env.testing)
      - name: Ejecutar migraciones
        run: docker-compose exec -T app php artisan migrate --force

      # âœ… 5. Ejecutar tests de PHPUnit usando SQLite
      - name: Ejecutar tests
        run: docker-compose exec -T app php artisan test

      # ğŸš€ 6. Despliegue automÃ¡tico (solo cuando se hace push a main)
      - name: Deploy a producciÃ³n
        if: github.ref == 'refs/heads/main'
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}           # IP o dominio del servidor
          username: ${{ secrets.SSH_USER }}       # Usuario SSH con acceso
          key: ${{ secrets.SSH_PRIVATE_KEY }}     # Clave privada SSH
          port: 22
          script: |
            echo "ğŸ“¥ Pull del cÃ³digo"
            cd /var/www/mi-proyecto
            git pull origin main

            echo "ğŸ§¹ Detener contenedores anteriores"
            docker-compose down

            echo "ğŸ”¨ Reconstruir y levantar contenedores"
            docker-compose up -d --build

            echo "âš™ï¸ Ejecutar migraciones"
            docker-compose exec -T app php artisan migrate --force

            echo "ğŸ› ï¸ Cachear configuraciÃ³n y rutas"
            docker-compose exec -T app php artisan config:clear
            docker-compose exec -T app php artisan config:cache
            docker-compose exec -T app php artisan route:cache
            docker-compose exec -T app php artisan view:cache

            echo "ğŸ¨ Compilar assets con Vite"
            docker-compose exec -T app npm install
            docker-compose exec -T app npm run build

            echo "âœ… Deploy completo"



DebÃ©s ir a tu repositorio en GitHub y cargar los siguientes secrets:

    SSH_HOST â†’ IP o dominio del servidor (ej. 198.51.100.123)

    SSH_USER â†’ Usuario con permisos de deploy (ej. deploy)

    SSH_PRIVATE_KEY â†’ Clave privada SSH (contenido de tu ~/.ssh/id_rsa o similar)
